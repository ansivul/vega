from mistralai import Mistral
import logging

logger = logging.getLogger(__name__)

class SummarizerService:
    def __init__(self, api_key: str):
        self.api_key = api_key
        self.client = None

    async def summarize(self, text: str) -> str:
        try:
            async with Mistral(api_key=self.api_key) as client:
                messages = [{
                    "role": "user",
                    "content": f"""–ü–µ—Ä–µ–ø–∏—à–∏ –Ω–æ–≤–æ—Å—Ç—å –≤ —Å—Ç–∏–ª–µ Telegram-–∫–∞–Ω–∞–ª–∞. –ü–∏—à–∏ –¢–û–õ–¨–ö–û —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç–∞, –±–µ–∑ –æ–±—ä—è—Å–Ω–µ–Ω–∏–π.
                    
                    {text}
                    
                    –ü—Ä–∞–≤–∏–ª–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è:
                    1. –ù–∞—á–∏–Ω–∞–π —Å —ç–º–æ–¥–∑–∏ (‚ö°Ô∏è, üî•, üí°, üö®) –∏ –∫—Ä–∞—Ç–∫–æ–≥–æ —è—Ä–∫–æ–≥–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞ —Å —Ç–∏—Ä–µ
                    2. –ü–æ—Å–ª–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —Å—Ç–∞–≤—å –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É
                    3. –î–∞–ª–µ–µ 2-3 –û–ß–ï–ù–¨ –ö–û–†–û–¢–ö–ò–• –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
                    4. –í–∞–∂–Ω—ã–µ —Å–ª–æ–≤–∞ –∏ —Ü–∏—Ñ—Ä—ã –≤—ã–¥–µ–ª—è–π –ö–ê–ü–°–û–ú
                    5. –í –∫–æ–Ω—Ü–µ - –æ–¥–Ω–æ –∫–æ—Ä–æ—Ç–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –∫–∞–∫ –≤—ã–≤–æ–¥
                    6. –û–±—â–∞—è –¥–ª–∏–Ω–∞ —Ç–µ–∫—Å—Ç–∞ - –Ω–µ –±–æ–ª—å—à–µ 500 —Å–∏–º–≤–æ–ª–æ–≤
                    7. –ü–∏—à–∏ –∂–∏–≤—ã–º —è–∑—ã–∫–æ–º, –∫–∞–∫ –¥–ª—è –¥—Ä—É–≥–∞
                    8. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ñ—Ä–∞–∑—ã "—á–∏—Ç–∞–π—Ç–µ –¥–∞–ª–µ–µ", "–ø–æ–¥—Ä–æ–±–Ω–µ–µ" –∏ —Ç.–ø.
                    9. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Å–æ–∫—Ä–∞—â–∞–π –≤—Å–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, —É–±–∏—Ä–∞–π –ª–∏—à–Ω–∏–µ —Å–ª–æ–≤–∞
                    
                    –ü—Ä–∏–º–µ—Ä —Ñ–æ—Ä–º–∞—Ç–∞:
                    ‚ö°Ô∏è Apple –°–í–û–†–ê–ß–ò–í–ê–ï–¢ —Ä–∞–±–æ—Ç—É –≤ –†–æ—Å—Å–∏–∏ ‚Äî –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏—è –Ω–µ –±—É–¥–µ—Ç
                    
                    –ö–æ–º–ø–∞–Ω–∏—è –∏–∑–º–µ–Ω–∏–ª–∞ —É—Å–ª–æ–≤–∏—è —Ä–∞–±–æ—Ç—ã –≤ –†–æ—Å—Å–∏–∏ –≤–ø–µ—Ä–≤—ã–µ —Å –≤–µ—Å–Ω—ã 2022 –≥–æ–¥–∞. Apple –ø—Ä–µ–∫—Ä–∞—â–∞–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫—É –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ –∏ –≤—ã–∫–ª–∞–¥—ã–≤–∞—Ç—å –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –≤ Apple TV+. –¢–∏–º –ö—É–∫ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –±—Ä–∞—Ç—å –¥–µ–Ω—å–≥–∏ –∏ –ø–ª–∞—Ç–∏—Ç—å —à—Ç—Ä–∞—Ñ—ã –≤ –†–æ—Å—Å–∏–∏.
                    
                    –í–æ–∑–≤—Ä–∞—â–µ–Ω–∏—è –≤ –†–æ—Å—Å–∏—é –º–æ–∂–Ω–æ –Ω–µ –∂–¥–∞—Ç—å."""
                }]

                response = await client.chat.complete_async(
                    model="mistral-large-latest",
                    messages=messages,
                )

                if response and response.choices:
                    return response.choices[0].message.content
                
                logger.warning("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç API")
                return text[:1000] + "..."
                
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ç–µ–∫—Å—Ç–∞ —á–µ—Ä–µ–∑ AI: {e}")
            return text[:1000] + "..." 