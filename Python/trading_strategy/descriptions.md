# Описание торгового скрипта

Этот скрипт представляет собой торговую стратегию для криптовалютного рынка, разработанную с использованием Python. Он анализирует рыночные данные с использованием различных технических индикаторов и предоставляет рекомендации для торговли на основе индекса страха и жадности (FGI), RSI, EMA, MACD, Bollinger Bands, уровней поддержки/сопротивления и ADX. Скрипт включает улучшенный расчет вероятности успеха на основе исторических данных, текущих трендов и подтверждений индикаторов.

## Основные возможности
- **Анализ рыночных данных**: Сбор и обработка данных OHLCV (Open, High, Low, Close, Volume) с биржи Bybit.
- **Технические индикаторы**:
  - **FGI (Fear and Greed Index)**: Оценка рыночных настроений (страх или жадность).
  - **RSI (Relative Strength Index)**: Определение зон перепроданности/перекупленности.
  - **EMA (Exponential Moving Average)**: Определение направления тренда (бычий/медвежий).
  - **MACD (Moving Average Convergence Divergence)**: Анализ импульса рынка.
  - **Bollinger Bands**: Оценка волатильности и экстремальных ценовых уровней.
  - **Уровни поддержки и сопротивления**: Определение ключевых ценовых зон на основе исторических данных.
  - **ADX (Average Directional Index)**: Оценка силы текущего тренда.
- **Расчет вероятности успеха**: Улучшенный алгоритм, учитывающий историческую успешность сигналов, силу тренда и подтверждения индикаторов.
- **Рекомендации**: Генерация торговых сигналов (long, short, нейтральная зона) с вероятностью успеха и детализированными выводами от ИИ.
- **Гибкая настройка**: Поддержка пользовательских параметров через файл `settings.json`.

## Параметры настройки (settings.json)

Ниже приведены параметры, доступные для настройки в файле `settings.json`, с их описанием и значениями по умолчанию:

| Параметр                  | Значение по умолчанию | Описание                                                                                   |
|---------------------------|-----------------------|--------------------------------------------------------------------------------------------|
| `symbol`                  | `"BTCUSDT"`           | Символ торговой пары (например, `BTCUSDT`, `ETHUSDT`, `XRPUSDT`, `BNBUSDT`).               |
| `timeframe`               | `"4h"`                | Таймфрейм для анализа (например, `1h`, `4h`, `1d`).                                        |
| `fgi_threshold_low`       | `25`                  | Нижний порог FGI для определения страха (0-25).                                            |
| `fgi_threshold_high`      | `75`                  | Верхний порог FGI для определения жадности (75-100).                                       |
| `rsi_threshold_low`       | `30`                  | Нижний порог RSI для определения перепроданности (0-30).                                   |
| `rsi_threshold_high`      | `70`                  | Верхний порог RSI для определения перекупленности (70-100).                                |
| `rsi_period`              | `14`                  | Период для расчета RSI (стандартное значение: 14 свечей).                                  |
| `ema_short_period`        | `12`                  | Период короткой EMA для определения краткосрочного тренда.                                 |
| `ema_long_period`         | `26`                  | Период длинной EMA для определения долгосрочного тренда.                                   |
| `macd_fast`               | `12`                  | Период быстрой линии MACD.                                                                 |
| `macd_slow`               | `26`                  | Период медленной линии MACD.                                                               |
| `macd_signal`             | `9`                   | Период сигнальной линии MACD.                                                              |
| `bollinger_period`        | `20`                  | Период для расчета Bollinger Bands (стандартное значение: 20 свечей).                      |
| `bollinger_deviation`     | `2`                   | Стандартное отклонение для Bollinger Bands (обычно 2).                                     |
| `support_resistance_window` | `10`                | Окно для определения уровней поддержки и сопротивления (количество свечей в каждую сторону, итого 20). |
| `show_explanations`       | `False`               | Флаг для вывода подробных пояснений к сигналам (`True`/`False`).                           |
| `historical_data_limit`   | `100`                 | Количество свечей для анализа исторических данных.                                         |
| `success_threshold`       | `0.02`                | Порог успеха в процентах (например, 2% роста/падения для определения успешности сигнала).  |
| `success_horizon`         | `5`                   | Горизонт для оценки успеха сигнала (количество свечей вперед).                             |
| `adx_period`              | `14`                  | Период для расчета ADX для оценки силы тренда.                                             |

## Описание терминов и логики работы стратегии

### 1. Основные термины
- **Бычий тренд (Bullish Trend)**:  
  - Описание: Восходящий тренд, когда короткая EMA (EMA Short) выше длинной EMA (EMA Long), что указывает на потенциальный рост цены.  
  - Пример: EMA Short = 87950, EMA Long = 87250 → Бычий тренд (87950 > 87250).

- **Медвежий тренд (Bearish Trend)**:  
  - Описание: Нисходящий тренд, когда короткая EMA ниже длинной EMA, что указывает на потенциальное снижение цены.  
  - Пример: EMA Short = 87250, EMA Long = 87950 → Медвежий тренд (87250 < 87950).

- **Бычий сигнал (Bullish Signal) в MACD**:  
  - Описание: Восходящий импульс, когда MACD Line выше Signal Line, что предполагает дальнейший рост.  
  - Пример: MACD Line = 800, Signal Line = 700 → Бычий сигнал (800 > 700).

- **Медвежий сигнал (Bearish Signal) в MACD**:  
  - Описание: Нисходящий импульс, когда MACD Line ниже Signal Line, что предполагает дальнейшее падение.  
  - Пример: MACD Line = 700, Signal Line = 800 → Медвежий сигнал (700 < 800).

- **Сила тренда (Trend Strength)**:  
  - Описание: Определяется с помощью ADX. Если ADX > 25, тренд считается сильным (`strong`), иначе слабым (`weak`).  
  - Пример: ADX = 30 → Сильный тренд; ADX = 20 → Слабый тренд.

### 2. Сценарии стратегии
Стратегия определяет пять возможных сценариев на основе FGI и RSI, с дополнительными подтверждениями от других индикаторов (объем, EMA, MACD, Bollinger Bands, уровни поддержки/сопротивления). Для сигнала требуется минимум 3 подтверждения из 5 индикаторов.

- **Сценарий 1: Согласованный сигнал (Long)**:  
  - **Условия**: FGI ≤ 25 (страх) и RSI ≤ 30 (перепроданность).  
  - **Подтверждения**:  
    - Объем: Текущий объем > предыдущего на 20% (`volume > prev_volume * 1.2`).  
    - EMA: EMA Short > EMA Long (бычий тренд).  
    - MACD: MACD Line > Signal Line (бычий сигнал).  
    - Bollinger Bands: Цена ≤ нижней полосы (перепроданность).  
    - Уровни: Цена в пределах 2% от поддержки (`abs(price - support) / price < 0.02`).  
  - **Рекомендация**:  
    - ≥ 3 подтверждения: "Рекомендую покупку".  
    - < 3 подтверждения: "Сигнал на покупку слабый, ждем подтверждения".  
  - **Пример**: FGI = 20, RSI = 25, Подтверждено: Объем, EMA, MACD → "Рекомендую покупку".

- **Сценарий 2: Согласованный сигнал (Short)**:  
  - **Условия**: FGI ≥ 75 (жадность) и RSI ≥ 70 (перекупленность).  
  - **Подтверждения**:  
    - Объем: Текущий объем > предыдущего на 20%.  
    - EMA: EMA Short < EMA Long (медвежий тренд).  
    - MACD: MACD Line < Signal Line (медвежий сигнал).  
    - Bollinger Bands: Цена ≥ верхней полосы (перекупленность).  
    - Уровни: Цена в пределах 2% от сопротивления (`abs(price - resistance) / price < 0.02`).  
  - **Рекомендация**:  
    - ≥ 3 подтверждения: "Рекомендую продажу".  
    - < 3 подтверждения: "Сигнал на продажу слабый, ждем подтверждения".  
  - **Пример**: FGI = 80, RSI = 75, Подтверждено: Объем, EMA, Bollinger → "Рекомендую продажу".

- **Сценарий 3: Перекос сигналов (Divergence Long)**:  
  - **Условия**: FGI ≥ 75 (жадность) и RSI ≤ 30 (перепроданность).  
  - **Подтверждения**: Те же, что для Long.  
  - **Рекомендация**:  
    - ≥ 3 подтверждения: "Рекомендую покупку".  
    - < 3 подтверждения: "Сигнал на покупку слабый, ждем подтверждения".  
  - **Пример**: FGI = 80, RSI = 25, Подтверждено: EMA, MACD, Уровни → "Рекомендую покупку".

- **Сценарий 4: Перекос сигналов (Divergence Short)**:  
  - **Условия**: FGI ≤ 25 (страх) и RSI ≥ 70 (перекупленность).  
  - **Подтверждения**: Те же, что для Short.  
  - **Рекомендация**:  
    - ≥ 3 подтверждения: "Рекомендую продажу".  
    - < 3 подтверждения: "Сигнал на продажу слабый, ждем подтверждения".  
  - **Пример**: FGI = 20, RSI = 75, Подтверждено: Объем, EMA, MACD → "Рекомендую продажу".

- **Сценарий 5: Нейтральная зона**:  
  - **Условия**: FGI и RSI не попадают в экстремальные значения (FGI > 25 и < 75, RSI > 30 и < 70).  
  - **Подтверждения для Long**: Те же, что для Long.  
  - **Подтверждения для Short**: Те же, что для Short.  
  - **Рекомендация**:  
    - ≥ 3 подтверждения для Long: "Возможна покупка".  
    - ≥ 3 подтверждения для Short: "Возможна продажа".  
    - Иначе: "Воздержаться или ждать пробоя с объемом".  
  - **Пример**: FGI = 50, RSI = 45, Подтверждено для Short: Объем, EMA, MACD → "Возможна продажа".

### 3. Интерпретация подтверждений
- **Объем**: Подтверждается, если текущий объем вырос на 20% по сравнению с предыдущим (`volume > prev_volume * 1.2`).  
  - Пример: Предыдущий объем = 1000, Текущий объем = 1300 → Подтверждено.
- **EMA**: Подтверждается, если направление тренда соответствует сигналу (EMA Short > EMA Long для Long, EMA Short < EMA Long для Short).  
  - Пример: EMA Short = 87950, EMA Long = 87250 → Подтверждено для Long.
- **MACD**: Подтверждается, если импульс соответствует сигналу (MACD Line > Signal Line для Long, MACD Line < Signal Line для Short).  
  - Пример: MACD Line = 800, Signal Line = 700 → Подтверждено для Long.
- **Bollinger Bands**: Подтверждается, если цена находится в экстремальной зоне (≤ нижней полосы для Long, ≥ верхней полосы для Short).  
  - Пример: Цена = 82000, Lower BB = 82330 → Не подтверждено для Long.
- **Уровни поддержки/сопротивления**: Подтверждается, если цена в пределах 2% от ключевого уровня (поддержки для Long, сопротивления для Short).  
  - Пример: Цена = 82100, Поддержка = 82122 → Подтверждено для Long.

## Логика работы

1. **Сбор данных**:  
   - Данные OHLCV загружаются с биржи Bybit через `ccxt`.  
   - FGI запрашивается через API Alternative.me.  

2. **Расчет индикаторов**:  
   - Используется библиотека `talib` для расчета RSI, EMA, MACD, Bollinger Bands и ADX.  
   - Уровни поддержки/сопротивления определяются как минимум и максимум за последние `support_resistance_window * 2` свечей.

3. **Определение сценария**:  
   - На основе FGI и RSI определяется текущий сценарий (Long, Short, Divergence Long, Divergence Short, Neutral).  
   - Проверяются дополнительные индикаторы для подтверждения сигнала.

4. **Анализ исторических данных**:  
   - Анализируются прошлые сигналы на основе `historical_data_limit` свечей.  
   - Успешность сигнала определяется как изменение цены на `success_threshold` (2%) в нужном направлении через `success_horizon` (5 свечей).  
   - Формируется статистика успешности для каждого сценария, тренда и силы тренда.

5. **Расчет вероятности успеха**:  
   - **Базовая вероятность**: 50% по умолчанию или процент успеха из исторических данных для текущего сценария, тренда и силы тренда.  
   - **Бонус за подтверждения**: +6% за каждое подтверждение (максимум +30% при 5 подтверждениях).  
   - Итоговая формула: `probability = base_probability + (confirmed_count / 5) * 30`.

6. **Вывод**:  
   - **Анализ рынка**: Текущая цена, объем, значения индикаторов и рекомендация.  
   - **Рекомендации от ИИ**: Оценка сигнала (сильный/слабый), вероятность успеха и советы.  
   - **Расчет вероятности успеха**: Подробный разбор базовой вероятности, бонуса и итогового значения.  
   - **Пояснения**: Опционально, если `show_explanations = True`.

## Пример вывода

=== Анализ рынка ===
Актив: BTCUSDT, Таймфрейм: 4h
Текущая цена: 79349.60 USDT, Объем: 5351.00
EMA: Short=82134.29, Long=84544.11, Медвежий тренд
MACD: Line=-2410.09, Signal=-2036.07, Медвежий сигнал
Bollinger Bands: Upper=89359.45, Middle=84036.06, Lower=78712.68
Уровни поддержки/сопротивления: Поддержка=79019.50, Сопротивление=87792.80
Рекомендация: Нейтральная зона: FGI = 20, RSI = 32.87. Воздержаться или ждать пробоя с объемом

=== Рекомендации от ИИ ===
Рынок в нейтральной зоне. Шанс успеха для покупки: 41%, для продажи: 62%. Воздержитесь или ждите пробоя с объемом.

--- Расчет вероятности успеха ---

Базовая вероятность: 50.00% 

Рассчитана на основе исторических данных для сценария 'neutral', тренда 'bearish' и силы тренда 'strong'.
  * Из 0 сигналов было успешно: 0.
  * Формула: (успешные сигналы / общее количество сигналов) * 100 = 50.00%.

Бонус за подтверждения: 6.00%
  * Всего индикаторов: 5 (объем, EMA, MACD, Bollinger Bands, уровни поддержки/сопротивления).
  * Подтверждено индикаторов: 1.
  * Формула: (количество подтверждений / общее количество индикаторов) * 30 = 6.00%.
  
Итоговая вероятность: 56.00%
  * Формула: базовая вероятность + бонус за подтверждения = 50.00 + 6.00 = 56.00%


## Зависимости
- `ccxt` - для взаимодействия с биржей.
- `pandas` - для обработки данных.
- `talib` - для расчета технических индикаторов.
- `requests` - для получения FGI.
- `json` - для работы с настройками.

## Установка
1. Установите зависимости:  `pip install .\requirements.txt`
2. Создайте файл `settings.json` с нужными параметрами.
3. Запустите скрипт: `python trading_strategy.py`


# Troubleshooting

**ERROR: Failed to build installable wheels for some pyproject.toml based projects (ta-lib)**  

Ошибка "fatal error: Killed signal terminated program cc1" часто свидетельствует о том, что процесс компиляции был принудительно завершён системой, например, из-за недостатка оперативной памяти. На сервере с 1 GB памяти это не редкость, особенно при сборке таких библиотек, как ta‑lib.

Чтобы решить эту проблему, можно попробовать следующие шаги:

_Увеличить swap‑память:_  
Создание swap‑файла позволит системе использовать дополнительное виртуальное пространство, что может помочь завершить сборку. Например, создайте swap‑файл объемом 2 GB:

```bash
sudo fallocate -l 2G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
```
Чтобы убедиться, что swap активен, выполните:

```bash
free -h
```

После этого повторите установку:
```bash
pip install ta-lib
```

Перед установкой Python‑библиотеки ta‑lib убедитесь, что на системе установлены необходимые библиотеки и заголовочные файлы:
```bash
sudo apt-get update
sudo apt-get install libta-lib0 libta-lib0-dev
```

ta-lib - [https://pypi.org/project/ta-lib/](https://pypi.org/project/ta-lib/)
vim /etc/systemd/system/bot_ts.service